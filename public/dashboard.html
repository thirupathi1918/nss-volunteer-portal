<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSS - Volunteer Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* NEW: Dashboard Loader Styles */
        #loader {
            position: fixed;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-family: 'Inter', sans-serif; color: #4a5568;">Syncing your dashboard...</p>
    </div>

    <div style="position: fixed; top: 10px; left: 10px; z-index: 1000;">
        <button onclick="handleLogout()" class="nav-btn-small logout-red">ðŸšª Logout</button>
    </div>

    <div class="background-animation">
        <img src="https://img.icons8.com/fluency/96/filled-like.png" class="floating-img" alt="heart">
        <img src="https://img.icons8.com/fluency/96/handshake.png" class="floating-img" alt="support">
    </div>

    <div class="container" style="width: 550px; max-width: 95%; margin-top: 50px;">
        <h2>NSS Volunteer Dashboard</h2>
        <div id="userProfile" style="text-align: left; background: rgba(240, 244, 248, 0.7); padding: 20px; border-radius: 15px; margin-bottom: 25px;">
            <p><strong>Logged in:</strong> <span id="dispEmail" style="color: #4a5568;"></span></p>
        </div>

        <h3>Support Our Mission</h3>
        <p style="font-size: 0.9rem; margin-bottom: 15px; color: #718096;">Official Razorpay Sandbox Integration.</p>
        
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="number" id="amt" placeholder="Amount (â‚¹)" min="1">
            <button id="payBtn">Pay Now (Sandbox)</button>
        </div>

        <p id="statusMsg" style="display:none; color: #6366f1; font-weight: bold; padding: 10px; background: #eef2ff; border-radius: 8px;">
            Status: <span id="statLabel">AWAITING...</span>
        </p>

        <hr style="border: 0; height: 1px; background: #e2e8f0; margin: 30px 0;">

        <h3>My Donation History</h3>
        <div style="overflow-x: auto;">
            <table style="width:100%; border-collapse: collapse;" border="1">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="history"></tbody>
            </table>
        </div>
    </div>

    <script>
        // NEW: Loader Removal Script
        window.addEventListener('load', () => {
            const loader = document.getElementById('loader');
            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 500);
        });

        const userEmail = localStorage.getItem('userEmail');
        if (!userEmail) window.location.href = 'index.html';
        document.getElementById('dispEmail').innerText = userEmail;

        async function loadHistory() {
            try {
                const res = await fetch('/api/admin-stats');
                const data = await res.json();
                const history = data.allDonations.filter(d => d.donorEmail === userEmail);
                document.getElementById('history').innerHTML = history.reverse().map(d => `
                    <tr>
                        <td>${d.timestamp}</td>
                        <td>â‚¹${d.amount}</td>
                        <td style="font-weight: bold; color: ${d.status === 'success' ? 'green' : (d.status === 'failed' ? 'red' : 'orange')}">
                            ${d.status.toUpperCase()}
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="3" style="text-align:center;">No history found</td></tr>';
            } catch (err) { console.error("History error:", err); }
        }

        document.getElementById('payBtn').addEventListener('click', async () => {
            const amount = document.getElementById('amt').value;
            if (!amount || amount <= 0) return alert("Please enter a valid amount.");

            const msg = document.getElementById('statusMsg');
            const labelEl = document.getElementById('statLabel');
            msg.style.display = "block";
            labelEl.innerText = "CONNECTING TO SERVER...";

            try {
                const initRes = await fetch('/api/initiate-donation', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ amount, email: userEmail })
                });
                const donation = await initRes.json();

                const options = {
                    "key": "rzp_test_S5LixUrRSjjgZq", 
                    "amount": amount * 100, 
                    "currency": "INR",
                    "name": "NSS NGO Portal",
                    "description": "Test Transaction for NSS Project",
                    "handler": async function (response) {
                        await fetch('/api/update-donation', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ id: donation.id, status: 'success' })
                        });
                        labelEl.innerText = "SUCCESSFUL";
                        loadHistory();
                    },
                    "modal": {
                        "ondismiss": async function() {
                            await fetch('/api/update-donation', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ id: donation.id, status: 'failed' })
                            });
                            labelEl.innerText = "CANCELLED";
                            loadHistory();
                        }
                    }
                };
                
                const rzp = new Razorpay(options);
                rzp.open();

            } catch (e) { 
                labelEl.innerText = "CONNECTION ERROR"; 
                alert("Server Connection Failed. Make sure your Vercel backend is running.");
            }
        });

        function handleLogout() {
            localStorage.removeItem('userEmail');
            window.location.href = 'index.html';
        }

        loadHistory(); 
    </script>
</body>
</html>